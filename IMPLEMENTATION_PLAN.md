<!-- Generated by LLM with content and structure it deems most appropriate -->

# Mountaineer V2 — Implementation Plan

> Last updated: 2026-03-01
> Status: Active — P0–P4 complete (all items). Remaining: P5.x (tray phase 2), P6.x (migration), P7.x (tests).

Items are sorted by priority. Each item references the authoritative spec(s).
Items marked **[DONE]** are confirmed complete against their spec.
Items marked **[PARTIAL]** have working code that needs corrections.
Items marked **[MISSING]** have no implementation.

---

## P0 — Architectural Foundation

These must be resolved first. Every other item depends on correct foundations.

### P0.0 Fix workspace manifest — project cannot build
- **Specs:** 01-design-principles
- **Status:** [DONE] — Root Cargo.toml converted to workspace with all 13 workspace deps, resolver, edition 2024, and `gpui_platform` with `runtime_shaders` feature. Stale root main.rs removed.

### P0.1 Wire `mod network;` declaration in main.rs
- **Specs:** 01-design-principles, 11-background-monitoring
- **Status:** [DONE] — Added `mod network;` to main.rs; network module (monitor.rs, interface.rs) now compiles and all 22 tests pass including 5 network tests.

### P0.2 Remove dual-mount code and `single_mount_mode` toggle
- **Specs:** 01-design-principles, 02-config-and-state
- **Status:** [DONE] — Removed all dual-mount code from config.rs and engine.rs (~200 lines), including `single_mount_mode`, `backend_mount_path`, `switch_share`, `mount_backends_for_shares`, and the `MountBackends` CLI command.

### P0.3 Fix volume paths — mount at `/Volumes/<SHARE>`, not backend-specific dirs
- **Specs:** 01-design-principles, 05-stable-paths
- **Status:** [DONE] — All mount paths now use `config::volume_mount_path(&share.share_name)` returning `/Volumes/<SHARE>`. `detect_active_backend` relies solely on `RuntimeState.active_backend`. macOS manages `/Volumes/` directories.

### P0.4 Fix config path from `~/Library/Application Support/` to `~/.mountaineer/`
- **Specs:** 01-design-principles, 02-config-and-state
- **Status:** [DONE] — Both `config_path()` and `state_path()` now use `dirs::home_dir().join(".mountaineer/")` per spec 02.

### P0.5 Fix `unmount_all` to preserve stable symlinks
- **Specs:** 08-bulk-operations, 05-stable-paths
- **Status:** [DONE] — Removed the symlink removal block from `unmount_all`; symlinks now persist across unmount per spec 05/08.

### P0.6 Fix `cmd_switch` to call `switch_backend_single_mount` instead of `switch_share`
- **Specs:** 10-cli-interface, 04-tb-recovery
- **Status:** [DONE] — `cmd_switch` reads the `from` backend from RuntimeState, calls `engine::switch_backend_single_mount`, and handles all `SwitchResult` variants with proper error messages.

### P0.7 Fix tray mount-from-none to go through engine, not bypass it
- **Specs:** 01-design-principles ("All UI actions call the same engine functions as CLI")
- **Status:** [DONE] — Replaced direct `mount::smb::mount_share` call in tray.rs with `engine::reconcile_all()`. Removed duplicate `set_symlink_atomically` from tray.rs.

### P0.8 Remove stale `watcher.rs`
- **Specs:** 01-design-principles (V1 pruning)
- **Status:** [DONE] — File deleted.

---

## P1 — CLI & Engine Spec Compliance

### P1.1 Add `--force` flag to `Switch` and `Unmount` CLI commands
- **Specs:** 04-tb-recovery, 08-bulk-operations, 10-cli-interface
- **Status:** [DONE] — Added `#[arg(long)] force: bool` to `Switch` and `Unmount` CLI commands. `unmount_all` now accepts `force: bool` — when true, skips `has_open_handles` check and uses hard unmount.

### P1.2 Add `lsof_recheck` field to `GlobalConfig`
- **Specs:** 02-config-and-state, 04-tb-recovery, 09-share-status
- **Status:** [DONE] — Added `lsof_recheck: bool` (default `true`) to `GlobalConfig`. Gates periodic lsof re-check in the auto-failback branch of `reconcile_share` per spec 04.

### P1.3 Implement `config set` CLI command
- **Specs:** 10-cli-interface
- **Status:** [DONE] — Added `Config` command with `Set` and `Show` subcommands supporting `lsof-recheck`, `auto-failback`, `check-interval`, and `connect-timeout` keys with input validation and atomic config save.

### P1.4 Make `favorites add` reject duplicates instead of upsert
- **Specs:** 06-favorites
- **Status:** [DONE] — Renamed `add_or_update_share` to `add_share`; returns `Err` on duplicate share name (case-insensitive). CLI propagates the error to the user.

### P1.5 Add `tb_recovery_pending` to `ShareStatus` / JSON output
- **Specs:** 09-share-status
- **Status:** [DONE] — Added `tb_recovery_pending: bool` to `ShareStatus`, populated from RuntimeState. CLI status table shows "TB READY" column; included in `--json` output via `Serialize`.

### P1.6 Atomic state persistence (temp-then-rename)
- **Specs:** 11-background-monitoring, 02-config-and-state
- **Status:** [DONE] — `save_runtime_state` writes to `state.json.tmp` then renames to `state.json`; crash mid-write cannot corrupt the state file.

### P1.7 Atomic config save
- **Specs:** 19-tray-quick-actions, 02-config-and-state
- **Status:** [DONE] — `Config::save()` writes to `config.toml.tmp` then renames to `config.toml`.

### P1.8 Make `uninstall` idempotent
- **Specs:** 12-launchd-integration
- **Status:** [DONE] — `uninstall()` now returns `Ok(())` with info log when plist is absent, instead of bailing with an error.

### P1.9 Fix `KeepAlive` plist value
- **Specs:** 12-launchd-integration
- **Status:** [DONE] — `generate_plist` now emits `<dict><key>SuccessfulExit</key><false/></dict>` so macOS auto-restarts on crash but stops on clean exit.

### P1.10 Config validation on load
- **Specs:** 02-config-and-state
- **Status:** [DONE] — Added `validate()` called from `load()`. Rejects empty required fields, duplicate share/alias names (case-insensitive). 7 new unit tests; 32 total tests passing.

### P1.11 Config hot-reload in `cmd_monitor`
- **Specs:** 11-background-monitoring
- **Status:** [DONE] — `cmd_monitor` now calls `config::load()` inside the poll loop before `reconcile_all`, matching the tray behavior per spec 11.

### P1.12 Implement failover retry policy
- **Specs:** 03-failover
- **Status:** [DONE] — `switch_backend_single_mount` retries mount once on failure before attempting rollback, per spec 03.

### P1.13 Implement stale mount pre-cleanup before remount
- **Specs:** 03-failover
- **Status:** [DONE] — `switch_backend_single_mount` detects stale mounts (mounted but not alive) at the target path and force-unmounts them before attempting mount.

### P1.14 Fix `cmd_mount` to not trigger failover on already-mounted shares
- **Specs:** 08-bulk-operations
- **Status:** [DONE] — Added `engine::mount_all()` that calls `reconcile_share` with `auto_switch=false`; `cmd_mount` now uses this instead of `reconcile_all` so already-mounted shares are untouched.

### P1.15 Handle errors from `favorites add` reconcile
- **Specs:** 06-favorites, 10-cli-interface
- **Status:** [DONE] — Post-add reconcile failures are reported to stderr as warnings. Config and symlink persist regardless; the command exits successfully since the favorite was saved.

---

## P2 — Network Event Integration

### P2.1 Wire SCDynamicStore events into V2 reconcile loop
- **Specs:** 11-background-monitoring
- **Status:** [DONE] — Both `cmd_monitor` and tray reconcile loop consume `network::monitor::start()` events. `cmd_monitor` uses `recv_timeout` on the network channel; tray uses a bridge thread + `AtomicBool` flag polled at 500ms granularity in the GPUI async loop.

### P2.2 Add 500ms debounce for network events
- **Specs:** 11-background-monitoring
- **Status:** [DONE] — Both `cmd_monitor` and tray bridge thread drain the network event channel for 500ms after the first event before triggering reconcile, preventing thrashing on rapid interface changes.

---

## P3 — Dead Code Cleanup

### P3.1 Remove or gate `wol.rs`
- **Specs:** 01-design-principles (WoL not in any spec as a current feature)
- **Status:** [DONE-NO-ACTION] — File is already excluded from compilation (no `mod wol;` in main.rs). No action needed until a WoL spec is authored.

### P3.2 Evaluate `network/interface.rs`
- **Specs:** None currently reference it
- **Status:** [DONE-NO-ACTION] — Module is already gated with `#[allow(dead_code)]` and has no callers. Keep for future use (richer status display, Thunderbolt NIC auto-detection); no action needed now.

### P3.3 Clean up unused functions in `discovery.rs`
- **Specs:** 01-design-principles (prune V1)
- **Status:** [DONE] — Removed all unused functions and the file-level `#![allow(dead_code)]`. Kept `is_smb_reachable_with_timeout` (active) and `check_share_available` (gated with `#[allow(dead_code)]`). 29 tests pass.

### P3.4 Deduplicate `set_symlink_atomically`
- **Status:** [DONE] — Duplicate removed from tray.rs; engine version promoted to `pub(crate)`.

### P3.5 Consolidate `share_statuses` and `verify_all`
- **Status:** [DONE] — Removed `share_statuses` one-line wrapper; `cmd_status` now calls `verify_all` directly.

### P3.6 Move alias symlink removal into engine
- **Specs:** 01-design-principles ("All UI actions call the same engine functions as CLI")
- **Status:** [DONE] — `engine::remove_alias` now removes the alias from config and cleans up the disk symlink; the CLI no longer does filesystem ops directly.

---

## P4 — Tray UI Enhancements (Current GPUI framework)

> **Architectural note:** Spec 01 mandates Swift/native for menu bar (not GPUI). These items
> are listed for completeness but implementation should be deferred until the GPUI -> Swift
> migration decision (P6) is resolved. If GPUI is kept short-term, these can proceed.
> Current tray is built on the `tray_icon` crate with GPUI providing the application runtime and async executor.

### P4.1 "Open Logs" quick action
- **Specs:** 19-tray-quick-actions
- **Status:** [DONE] — Added "Open Logs" menu item (id `"open-logs"`) that calls `logging::log_path()` and opens the file. Changed `logging::log_path()` to `pub(crate)`.

### P4.2 `auto_failback` toggle in tray
- **Specs:** 19-tray-quick-actions
- **Status:** [DONE] — Added "Auto Failback [on/off]" toggle menu item that loads config, toggles `auto_failback`, saves atomically, and rebuilds the menu.

### P4.3 `lsof_recheck` toggle in tray
- **Specs:** 19-tray-quick-actions
- **Status:** [DONE] — Added "Lsof Recheck [on/off]" toggle menu item using the same `toggle_config_bool` helper pattern as P4.2.

### P4.4 Visual toggle state indicators
- **Specs:** 19-tray-quick-actions
- **Status:** [DONE] — Toggle items show "[on]" or "[off]" text labels reflecting current config state; menu is rebuilt after each toggle.

### P4.5 `last_error` display per share
- **Specs:** 18-tray-status-display
- **Status:** [DONE] — Share submenus show `! <error message>` when `last_error` is non-empty, separated by a divider.

### P4.6 Dynamic tray icon reflecting overall health
- **Specs:** 18-tray-status-display
- **Status:** [DONE] — Icon changes color based on aggregate health: white (all healthy), yellow/amber (degraded), red (all disconnected). Updated after every reconcile cycle via `HealthState` enum and `compute_health()`.

### P4.7 Force-switch option on open-files warning
- **Specs:** 14-tray-tb-recovery
- **Status:** [DONE] — When `BusyOpenFiles` is returned, the share is tracked as "busy" and the menu shows a warning ("Open files blocking switch") plus a "Force Switch to {backend} (may lose data!)" option. Force-switch calls `switch_backend_single_mount` with `force=true`. Busy state is cleared on successful switch or on next reconcile cycle.

### P4.8 In-progress indicators during switch/mount operations
- **Specs:** 14-tray-tb-recovery, 17-tray-bulk-operations
- **Status:** [DONE] — Added `in_progress: Option<String>` to `TrayState`. Before a switch operation, the message is set (e.g., "Switching SHARE to TB..."), the menu is rebuilt to show it, then the switch executes. The indicator is cleared after completion. Displayed below the "Mountaineer" title in the menu.

---

## P5 — Tray UI Phase 2 Features

### P5.1 Favorites management from tray
- **Specs:** 15-tray-favorites
- **Status:** [MISSING]
- **Evidence:** Engine functions exist (`add_share`, `remove_share`, `cleanup_removed_share`) and are used by CLI. No tray UI wiring.
- **Work:** "Add Favorite" form (companion window or panel — tray menus have limited input capability), "Remove Favorite" per-share action with confirmation dialog and alias impact reporting. Calls same engine functions as CLI.

### P5.2 Alias management from tray
- **Specs:** 16-tray-aliases
- **Status:** [MISSING]
- **Evidence:** Engine functions exist (`add_alias`, `remove_alias`, `inspect_aliases`, `list_folders`) and are used by CLI. No tray UI wiring.
- **Work:** Folder browser (companion window — share must be mounted), alias creation/removal. Calls same engine functions.

### P5.3 Bulk operations from tray
- **Specs:** 17-tray-bulk-operations
- **Status:** [MISSING]
- **Evidence:** Engine functions exist (`reconcile_all`, `unmount_all`) and are used by CLI. No tray UI wiring.
- **Work:** "Mount All" and "Unmount All" menu items. No force-unmount in tray (CLI only per spec). Show per-share results after operation.

---

## P6 — GPUI -> Swift/Native Migration

### P6.1 Replace GPUI with native macOS menu bar implementation
- **Specs:** 01-design-principles (explicit: "Menu bar UI uses native Swift or a lightweight macOS-native framework -- explicitly NOT GPUI")
- **Status:** [PARTIAL] — GPUI is used for the entire tray/menu bar system
- **Files:** `crates/mountaineer/src/gui.rs`, `crates/mountaineer/src/tray.rs`, `crates/mountaineer/Cargo.toml` (GPUI deps)
- **Evidence:**
  - `gui.rs` creates `gpui::Application`, sets `NSApplication.setActivationPolicy(1)` (Accessory) via unsafe ObjC, delegates to `tray::install`
  - `tray.rs` uses `gpui::AsyncApp`, `cx.spawn(...)`, `cx.background_executor().timer(...)`, `cx.quit()` for the async runtime
  - Actual menu is built with `tray_icon` crate (native NSStatusItem) — not GPUI views
  - GPUI provides the application lifecycle and async executor only — no GPUI views/elements/windows are rendered
- **Work:**
  - **Option A:** Swift companion app with XPC or CLI bridge to Rust engine
  - **Option B:** Rust `objc2`/`cocoa` crate for direct AppKit `NSStatusItem` + `NSApplication.run()` — replace GPUI as the app lifecycle/async runtime
  - **Option C:** Keep GPUI short-term, migrate later when tray features stabilize
  - **Recommendation:** Resolve this architectural decision before implementing P4/P5 tray features to avoid throwaway work. Note: GPUI is only used as a runtime host, not for rendering — migration scope is smaller than it appears.
- **Impact:** Affects all P4 and P5 items. If migrating, those should be built in the new framework.

---

## P7 — Test Coverage

### P7.1 Unit tests for config load/save round-trip
- **Files:** `crates/mountaineer/src/config.rs`
- **Work:** Test TOML serialization/deserialization, path expansion, validation, atomic save

### P7.2 Unit tests for CLI dispatch
- **Files:** `crates/mountaineer/src/main.rs`, `crates/mountaineer/src/cli.rs`
- **Work:** Test clap argument parsing for all commands including `--force` flags and `config set`

### P7.3 Integration tests for engine reconciliation
- **Files:** `crates/mountaineer/src/engine.rs`
- **Work:** Mock mount/unmount/probe functions; test failover and recovery state machines, TB stability window, lsof_recheck gating

### P7.4 Tests for launchd install/uninstall
- **Files:** `crates/mountaineer/src/launchd.rs`
- **Work:** Test plist generation content, KeepAlive dict structure, idempotent uninstall

### P7.5 Remove or fix system-dependent tests
- **Files:** `crates/mountaineer/src/discovery.rs`, `crates/mountaineer/src/network/interface.rs`
- **Work:** Mock system calls or mark with `#[ignore]` for tests that depend on dev machine network state

---

## Confirmed Working (No Action Needed)

- **Failover guard logic** (Spec 03): `reconcile_share` checks `other_reachable` before calling `switch_backend_single_mount` — TB is NOT unmounted if FB is unreachable.
- **Dual-mode logging** (Spec 13): `logging.rs` correctly implements `LoggingMode::Gui` (file-only) and `LoggingMode::Cli` (stderr + file) with `LineWriter`. Log path consistent between `logging::log_path()` and `launchd::generate_plist()`.
- **Alias lifecycle** (Spec 07): `add_alias` validates share exists and rejects duplicate alias names case-insensitively. `reconcile_aliases` called from `reconcile_all`. Atomic symlink creation via `set_symlink_atomically`.
- **auto_failback defaults to false** (Spec 02): `default_auto_failback()` returns `false`. Correct.
- **TB stability window** (Spec 04): `auto_failback_stable_secs` (default 30) checked before auto-failback. Window resets when TB drops. Correct.
- **Rollback on mount failure** (Spec 04): `switch_backend_single_mount` attempts remount of old backend on failure and restores symlink if rollback succeeds.
- **TB recovery pending clears on TB drop** (Spec 04): `tb_recovery_pending = false` set when TB becomes unreachable. Correct.
- **shares_root config field** (Spec 02/05): `shares_root_path(config)` reads from `config.global.shares_root` (default `~/Shares`), not hardcoded.
- **Tray config hot-reload** (Spec 11): tray.rs calls `config::load()` on every reconcile cycle. Correct.

---

## Environment & Toolchain Notes

- **gpui API change:** `Application::new()` no longer exists. Must use `gpui_platform::application()` which calls `Application::with_platform(current_platform(false))`. `gpui_platform` added as workspace dep with `runtime_shaders` feature.
- **Xcode license blocker:** Building requires either Xcode license accepted or `DEVELOPER_DIR=/Library/Developer/CommandLineTools` env var set. The `runtime_shaders` feature on `gpui_platform` avoids requiring the Metal toolchain at build time.
- **Root main.rs:** A stale GPUI hello-world `main.rs` existed at the repo root (not in `src/`). Deleted as part of workspace manifest cleanup (P0.0).

---

## Summary — Implementation Order

```
Phase 1: Foundation (P0.0 -> P0.8)
  [DONE] Fix workspace manifest -> [DONE] Wire mod network -> [DONE] Remove dual-mount ->
  [DONE] Fix volume paths + detect_active_backend -> [DONE] Fix config path ->
  [DONE] Fix unmount symlink preservation -> [DONE] Fix cmd_switch -> [DONE] Fix tray engine bypass ->
  [DONE] Remove watcher.rs

Phase 2: Spec Compliance (P1.1 -> P1.15)
  --force flags -> lsof_recheck -> config set -> reject duplicates ->
  tb_recovery_pending in status -> atomic persistence -> idempotent uninstall ->
  KeepAlive fix -> config validation -> config hot-reload ->
  failover retry -> stale mount pre-cleanup ->
  fix cmd_mount auto-switch -> fix favorites add error handling

Phase 3: Network Events (P2.1 -> P2.2)
  Wire SCDynamicStore -> Add debounce

Phase 4: Dead Code (P3.1 -> P3.6)
  Gate wol.rs -> Evaluate interface.rs -> Clean discovery.rs ->
  Dedup symlink fn -> Consolidate share_statuses/verify_all ->
  Move alias symlink removal into engine

Phase 5: Architectural Decision (P6.1)
  Decide GPUI vs Swift/native -- blocks P4/P5

Phase 6: Tray Enhancements (P4.1 -> P4.8)
  Quick actions -> Toggles -> Error display -> Dynamic icon -> Force-switch -> Progress

Phase 7: Tray Phase 2 (P5.1 -> P5.3)
  Favorites UI -> Alias UI -> Bulk ops UI

Phase 8: Test Coverage (P7.1 -> P7.5)
  Config tests -> CLI tests -> Engine tests -> Launchd tests -> Fix flaky tests
```

---

## Change Log

### 2026-03-01 (v14 — P4.8 in-progress indicators, P4 complete)
- **P4.8 [DONE]:** In-progress "Switching..." indicator shown in menu during switch operations. All P4 items now complete.

### 2026-03-01 (v13 — P4.7 force-switch)
- **P4.7 [DONE]:** Force-switch option on open-files warning. Tracks busy shares in TrayState, shows warning + force-switch menu item, calls switch with `force=true`. 29 tests pass.

### 2026-03-01 (v12 — P4.6 dynamic tray icon)
- **P4.6 [DONE]:** Dynamic tray icon with white/yellow/red health states. Updated after every reconcile cycle. 29 tests pass.

### 2026-03-01 (v11 — P4 tray UI enhancements)
- **P4.1–P4.5 [DONE]:** Open Logs action, auto_failback/lsof_recheck toggles with [on/off] labels, last_error display in share submenus. 29 tests pass.

### 2026-03-01 (v10 — P3 dead code cleanup)
- **P3.3–P3.6 [DONE]:** Cleaned discovery.rs, promoted set_symlink_atomically to pub(crate), moved alias symlink removal into engine. 29 tests pass.

### 2026-03-01 (v9 — P2 network event integration)
- **P2.1–P2.2 [DONE]:** Wired SCDynamicStore events into cmd_monitor and tray; 500ms debounce on both paths. 32 tests pass.

### 2026-02-27 (v8 — P1 full completion)
- **P1.3–P1.4, P1.10, P1.12–P1.15 [DONE]:** config set command, duplicate rejection, config validation, failover retry, stale mount pre-cleanup, mount_all, favorites error reporting. 32 tests pass.

### 2026-02-27 (v7 — P1 spec compliance batch)
- **P1.1–P1.2, P1.5–P1.9, P1.11, P3.5 [DONE]:** --force flags, lsof_recheck, tb_recovery_pending status, atomic persistence, idempotent uninstall, KeepAlive fix, config hot-reload, share_statuses consolidation. 25 tests pass.

### 2026-02-27 (v6 — P0 complete)
- **P0.2–P0.3, P0.6–P0.7 [DONE]:** Removed dual-mount code, fixed volume paths, fixed cmd_switch, fixed tray engine bypass. 25 tests pass. All P0 items complete.

### 2026-02-27 (v5 — P0 partial completion)
- **P0.0–P0.1, P0.4–P0.5, P0.8 [DONE]:** Workspace manifest, network mod, config path, symlink preservation, watcher.rs removal. Added Environment & Toolchain Notes section.

### 2026-02-27 (v4 — full re-verification)
- Full re-verification with parallel subagents. Added P1.14, P1.15, P3.6. Updated P4.1 note about log_path visibility. All existing items confirmed accurate.

### 2026-02-27 (v3 — comprehensive audit)
- Added "Confirmed Working" section. Expanded P0.2, P0.3, P1.2, P1.13, P3.3. Clarified P4 GPUI-vs-tray_icon architecture. Added evidence sections with exact line numbers throughout.

### 2026-02-27 (v2)
- Added P0.0, P0.1, P0.7, P1.12, P1.13, P3.5. Renumbered items to reflect dependency chain. Updated all file paths to absolute crates/ prefixes.
