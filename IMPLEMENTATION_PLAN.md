<!-- Generated by LLM with content and structure it deems most appropriate -->

# Mountaineer V2 — Implementation Plan

> Last updated: 2026-02-27
> Status: Active — P0.0–P0.8 complete; P1.1, P1.2, P1.5, P1.6, P1.7, P1.8, P1.9, P1.11, P3.5 complete.

Items are sorted by priority. Each item references the authoritative spec(s).
Items marked **[DONE]** are confirmed complete against their spec.
Items marked **[PARTIAL]** have working code that needs corrections.
Items marked **[MISSING]** have no implementation.

---

## P0 — Architectural Foundation

These must be resolved first. Every other item depends on correct foundations.

### P0.0 Fix workspace manifest — project cannot build
- **Specs:** 01-design-principles
- **Status:** [DONE] — Root Cargo.toml converted to workspace with `[workspace]`, members, resolver, and `[workspace.dependencies]`. All 13 workspace deps defined with correct versions. Edition set to 2024 via workspace.package. `gpui_platform` added as new workspace dep (with `runtime_shaders` feature). Root main.rs (hello world) removed. Cargo.lock updated.

### P0.1 Wire `mod network;` declaration in main.rs
- **Specs:** 01-design-principles, 11-background-monitoring
- **Status:** [DONE] — Added `mod network;` to main.rs. Network module now compiles (monitor.rs and interface.rs). All 22 tests pass including 5 network tests.

### P0.2 Remove dual-mount code and `single_mount_mode` toggle
- **Specs:** 01-design-principles, 02-config-and-state
- **Status:** [DONE] — Removed `single_mount_mode`, `mount_root`, `backend_mount_path()`, `sanitize_share_name()`, `mount_suffix()`, `default_mount_root()`, `default_single_mount_mode()` from config.rs. Removed `switch_share()` (dual-mount switch), `choose_desired_backend()` (dual-mount version), `mount_backends_for_shares()` from engine.rs. Removed dual-mount branch from `reconcile_share` (lines 850-893). Removed `single_mount_mode` parameter from `probe_backend`. Simplified `unmount_all` and `unmount_all_for_share` to unmount only the single active mount. Removed `MountBackends` CLI command. Removed `backend_paths_use_suffixes` test. Added 3 new tests for `choose_desired_backend`. Engine dropped ~200 lines of dual-mount branching.

### P0.3 Fix volume paths — mount at `/Volumes/<SHARE>`, not backend-specific dirs
- **Specs:** 01-design-principles, 05-stable-paths
- **Status:** [DONE] — All mount paths now use `config::volume_mount_path(&share.share_name)` which returns `/Volumes/<SHARE>`. Removed `backend_mount_path` entirely. `detect_active_backend` now relies solely on `RuntimeState.active_backend` (since symlink target is identical for both backends under /Volumes). Stable symlinks point to `/Volumes/<SHARE>`. Mountaineer does NOT create mount point directories under `/Volumes/` — macOS manages this.

### P0.4 Fix config path from `~/Library/Application Support/` to `~/.mountaineer/`
- **Specs:** 01-design-principles, 02-config-and-state
- **Status:** [DONE] — Changed `config_path()` and `state_path()` from `dirs::config_dir()` to `dirs::home_dir().join(".mountaineer/")`. Now uses `~/.mountaineer/config.toml` and `~/.mountaineer/state.json` per spec 02.

### P0.5 Fix `unmount_all` to preserve stable symlinks
- **Specs:** 08-bulk-operations, 05-stable-paths
- **Status:** [DONE] — Removed the `if is_symlink(&stable) { let _ = fs::remove_file(&stable); }` block. Symlinks now persist across unmount per spec 05/08.

### P0.6 Fix `cmd_switch` to call `switch_backend_single_mount` instead of `switch_share`
- **Specs:** 10-cli-interface, 04-tb-recovery
- **Status:** [DONE] — `cmd_switch` in main.rs now reads `from` backend from RuntimeState, calls `engine::switch_backend_single_mount`, and handles all `SwitchResult` variants with proper error messages.

### P0.7 Fix tray mount-from-none to go through engine, not bypass it
- **Specs:** 01-design-principles ("All UI actions call the same engine functions as CLI")
- **Status:** [DONE] — Replaced the direct `mount::smb::mount_share` block in tray.rs `handle_switch` with `engine::reconcile_all()` call. Tray no longer bypasses the engine for initial mounts. Also removed duplicate `set_symlink_atomically` from tray.rs (P3.4 partially addressed).

### P0.8 Remove stale `watcher.rs`
- **Specs:** 01-design-principles (V1 pruning)
- **Status:** [DONE] — File deleted.

---

## P1 — CLI & Engine Spec Compliance

### P1.1 Add `--force` flag to `Switch` and `Unmount` CLI commands
- **Specs:** 04-tb-recovery, 08-bulk-operations, 10-cli-interface
- **Status:** [DONE] — Added `#[arg(long)] force: bool` to `Switch` and `Unmount` CLI commands. `cmd_switch` threads `force` to `switch_backend_single_mount`. `cmd_unmount` threads `force` to `unmount_all`. `unmount_all` now accepts `force: bool` — when true, skips `has_open_handles` check and uses hard `unmount` instead of `unmount_graceful`.
- **Files:** `crates/mountaineer/src/cli.rs`, `crates/mountaineer/src/main.rs`, `crates/mountaineer/src/engine.rs`
- **Evidence:**
  - `Command::Switch` at cli.rs:36-41 has `share: String` and `to: Backend` only — no `force`
  - `Command::Unmount` at cli.rs:57-60 has `all: bool` only — no `force`
  - `engine::switch_backend_single_mount` already accepts `force: bool` parameter (engine.rs:238)
  - `engine::unmount_all` does NOT accept `force` — it always uses `has_open_handles` check
- **Work:**
  - Add `#[arg(long)] force: bool` to `Switch` command struct
  - Add `#[arg(long)] force: bool` to `Unmount` command struct
  - Thread `force` into `cmd_switch` -> `switch_backend_single_mount` (already accepts `force: bool`)
  - Thread `force` into `cmd_unmount` -> `unmount_all` (must add force param to skip `has_open_handles`)

### P1.2 Add `lsof_recheck` field to `GlobalConfig`
- **Specs:** 02-config-and-state, 04-tb-recovery, 09-share-status
- **Status:** [DONE] — Added `lsof_recheck: bool` (default `true`) to `GlobalConfig` with `#[serde(default = "default_lsof_recheck")]`. In reconcile_share auto-failback branch, when `lsof_recheck` is false, passes `force=true` to `switch_backend_single_mount` to skip open-file checks per spec 04.
- **Files:** `crates/mountaineer/src/config.rs`, `crates/mountaineer/src/engine.rs`
- **Evidence:**
  - Spec 02 line 9 lists `lsof_recheck` as a required `[global]` field with default `true`
  - Spec 04 lines 14-15: gates periodic lsof re-check each reconcile cycle
  - Grep for `lsof_recheck` across entire `crates/` returns zero results
- **Work:**
  - Add `lsof_recheck: bool` (default `true`) to `GlobalConfig` with `#[serde(default = "default_lsof_recheck")]`
  - In `reconcile_share` single-mount TB-recovery branch (engine.rs:758-820): when `auto_failback=true` and `tb_recovery_pending`, gate the `has_open_handles` re-check on `config.global.lsof_recheck`
  - Include in status output (see P1.5)

### P1.3 Implement `config set` CLI command
- **Specs:** 10-cli-interface
- **Status:** [MISSING]
- **Files:** `crates/mountaineer/src/cli.rs`, `crates/mountaineer/src/main.rs`, `crates/mountaineer/src/config.rs`
- **Evidence:**
  - Spec 10 lists `config set lsof-recheck on|off` as a required command
  - No `Config` variant exists in the `Command` enum (cli.rs:17-82)
- **Work:**
  - Add `Config` variant to `Command` enum with subcommands: `Set { key: String, value: String }`
  - Support keys: `lsof-recheck` (on/off), `auto-failback` (on/off), `check-interval` (seconds), `connect-timeout` (ms)
  - Handler loads config, modifies field, saves config
  - Use atomic save (see P1.7)

### P1.4 Make `favorites add` reject duplicates instead of upsert
- **Specs:** 06-favorites
- **Status:** [PARTIAL] — `engine::add_or_update_share` upserts (returns `bool` for updated vs. added)
- **Files:** `crates/mountaineer/src/engine.rs` (line 509), `crates/mountaineer/src/main.rs`
- **Evidence:**
  - `add_or_update_share` at engine.rs:509-516 does case-insensitive search and updates if found, adds if not — returns `bool` indicating update
  - Spec 06: "Duplicate share names must be rejected on add"
- **Work:**
  - Rename to `add_share`; return `Err` if share name already exists (case-insensitive)
  - Update `cmd_favorites_add` (main.rs:370) to handle/display the error

### P1.5 Add `tb_recovery_pending` to `ShareStatus` / JSON output
- **Specs:** 09-share-status
- **Status:** [DONE] — Added `tb_recovery_pending: bool` field to `ShareStatus`. Populated from `RuntimeState` entry in `reconcile_share` return value. CLI `print_status_table` now shows "TB READY" column with "YES" when `tb_recovery_pending` is true. Included in `--json` output via `Serialize`.
- **Files:** `crates/mountaineer/src/engine.rs`
- **Evidence:**
  - `ShareStatus` (engine.rs:44-54) has no `tb_recovery_pending` field
  - `ShareRuntimeState` (engine.rs:30) has `tb_recovery_pending: bool`
  - Tray reads it from `guard.runtime_state.shares.get(name).map(|e| e.tb_recovery_pending)` at tray.rs:283-285
  - Spec 09: "TB Ready" indicator when `tb_recovery_pending` is true — must be prominent
  - `print_status_table` in main.rs:492 does not show TB Ready indicator
- **Work:**
  - Add `tb_recovery_pending: bool` field to `ShareStatus` struct
  - Populate from `RuntimeState` in `reconcile_share` return value
  - Show "TB Ready" in CLI `print_status_table` output
  - Add `lsof_recheck: bool` to a global status section in `--json` output

### P1.6 Atomic state persistence (temp-then-rename)
- **Specs:** 11-background-monitoring, 02-config-and-state
- **Status:** [DONE] — `save_runtime_state` now writes to `state.json.tmp` then `fs::rename` to `state.json` for atomic persistence. Crash mid-write cannot corrupt the state file.
- **Files:** `crates/mountaineer/src/engine.rs` (lines 103-113)
- **Evidence:**
  - `save_runtime_state` at engine.rs:108 calls `fs::write(&path, text)` — non-atomic
  - A crash mid-write would corrupt `state.json`
- **Work:**
  - Write to `state.json.tmp`, then `fs::rename` to `state.json`
  - Same pattern as `set_symlink_atomically`

### P1.7 Atomic config save
- **Specs:** 19-tray-quick-actions, 02-config-and-state
- **Status:** [DONE] — `Config::save()` now writes to `config.toml.tmp` then `fs::rename` to `config.toml` for atomic persistence.
- **Files:** `crates/mountaineer/src/config.rs` (line 155)
- **Evidence:**
  - `save()` at config.rs:155 calls `fs::write(&path, toml)` — non-atomic
- **Work:**
  - Write to `config.toml.tmp`, then `fs::rename` to `config.toml`

### P1.8 Make `uninstall` idempotent
- **Specs:** 12-launchd-integration
- **Status:** [DONE] — `uninstall()` now returns `Ok(())` with info log when plist not found, instead of `bail!()`.
- **Files:** `crates/mountaineer/src/launchd.rs` (lines 97-99)
- **Evidence:**
  - `uninstall()` at launchd.rs:97-99: `if !plist.exists() { anyhow::bail!("LaunchAgent is not installed (no plist found)"); }`
  - Spec 12: "Uninstall is idempotent — no error if plist does not exist"
- **Work:**
  - If plist file doesn't exist, return `Ok(())` with info log instead of error

### P1.9 Fix `KeepAlive` plist value
- **Specs:** 12-launchd-integration
- **Status:** [DONE] — `KeepAlive` in `generate_plist` now emits `<dict><key>SuccessfulExit</key><false/></dict>` per spec 12. macOS will auto-restart on crash but stop on clean exit.
- **Files:** `crates/mountaineer/src/launchd.rs` (line 42)
- **Evidence:**
  - `generate_plist` at launchd.rs:41-42 emits `<key>KeepAlive</key>\n<false/>`
  - Spec 12 requires `KeepAlive = { SuccessfulExit = false }` so macOS auto-restarts on crash but stops on clean quit
- **Work:**
  - Replace `<key>KeepAlive</key>\n<false/>` with:
    ```xml
    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
    </dict>
    ```

### P1.10 Config validation on load
- **Specs:** 02-config-and-state
- **Status:** [MISSING]
- **Files:** `crates/mountaineer/src/config.rs`
- **Evidence:**
  - `load()` at config.rs:135-146 only does `toml::from_str` — no field-level validation
  - Spec 02 line 19: "MUST validate config on load: reject missing required fields, duplicate share names, invalid hosts"
- **Work:**
  - Reject duplicate share names (case-insensitive)
  - Reject missing required fields (name, thunderbolt_host, fallback_host — serde will catch missing but not empty)
  - Reject empty required string fields
  - Reject duplicate alias names (case-insensitive)
  - Warn on unreachable hosts (optional, could be runtime)

### P1.11 Config hot-reload in `cmd_monitor`
- **Specs:** 11-background-monitoring
- **Status:** [DONE] — `cmd_monitor` now calls `config::load()` inside the poll loop (before `reconcile_all`) per spec 11. Falls back to initial config on load error.
- **Files:** `crates/mountaineer/src/main.rs` (lines 130-152)
- **Evidence:**
  - `cmd_monitor` at main.rs:131 calls `config::load()` once before the loop
  - `tray.rs:74` correctly calls `config::load()` on every loop iteration
  - Spec 11: "MUST support config hot-reload: re-read config on each cycle"
- **Work:**
  - Move `config::load()` call inside the `cmd_monitor` poll loop (before `reconcile_all`)

### P1.12 Implement failover retry policy
- **Specs:** 03-failover
- **Status:** [MISSING] — no retry logic exists
- **Files:** `crates/mountaineer/src/engine.rs`
- **Evidence:**
  - Spec 03 line 14: "If Fallback mount fails after TB unmounted: retry Fallback once"
  - `switch_backend_single_mount` at engine.rs:310-341 attempts mount once, then immediately attempts rollback on failure — no retry
- **Work:**
  - After a failed fallback mount in `switch_backend_single_mount`, retry once before rolling back
  - Hardcode per spec (one retry)

### P1.13 Implement stale mount pre-cleanup before remount
- **Specs:** 03-failover
- **Status:** [PARTIAL] — `probe_backend` does stale mount cleanup (engine.rs:1039-1071) but `switch_backend_single_mount` does not
- **Files:** `crates/mountaineer/src/engine.rs`
- **Evidence:**
  - Spec 03 line 20: "MUST detect and clean up stale/hung mounts before attempting remount"
  - `probe_backend` (engine.rs:1039-1071) detects stale mounts (mounted && !alive) and force-unmounts them — but this only runs during reconciliation probes
  - `switch_backend_single_mount` does NOT check for stale mounts at the target path before mounting
  - Scenario: user triggers `switch --to tb`, the `/Volumes/<SHARE>` path has a stale FB mount, `mount_share` fails because path is occupied
- **Work:**
  - Before attempting a mount in `switch_backend_single_mount`, check if target path has a stale mount
  - If stale mount detected (mounted but not alive), force-unmount it before attempting remount
  - Log the stale mount cleanup action

### P1.14 Fix `cmd_mount` to not trigger failover on already-mounted shares
- **Specs:** 08-bulk-operations
- **Status:** [PARTIAL] — `cmd_mount` delegates to `engine::reconcile_all` which runs full failover/recovery
- **Files:** `crates/mountaineer/src/main.rs` (lines 218-231), `crates/mountaineer/src/engine.rs`
- **Evidence:**
  - `cmd_mount` at main.rs:222 calls `engine::reconcile_all(&cfg, &mut state)` — identical to `cmd_reconcile`
  - `reconcile_all` calls `reconcile_share(... attempt_mount=true, auto_switch=true ...)` at engine.rs:129
  - `auto_switch=true` enables failover and recovery logic on already-mounted shares
  - Spec 08 line 8: "Skip shares that are already mounted — do not unmount and remount"
  - Scenario: user runs `mount --all` to mount unmounted shares, but it unexpectedly triggers TB→fallback failover on a share that was mounted but whose TB went down during the last cycle
- **Work:**
  - Either: (a) Create a dedicated `mount_all` engine function that calls `reconcile_share` with `auto_switch=false`, or (b) Add a `mount_only: bool` parameter to `reconcile_all` that suppresses switch logic
  - `mount --all` should mount unmounted shares via best interface but leave already-mounted shares untouched

### P1.15 Handle errors from `favorites add` reconcile
- **Specs:** 06-favorites, 10-cli-interface
- **Status:** [PARTIAL] — errors silently discarded
- **Files:** `crates/mountaineer/src/main.rs` (line 374)
- **Evidence:**
  - `cmd_favorites add` at main.rs:374: `let _ = engine::reconcile_selected(&cfg, &mut state, std::slice::from_ref(&share))`
  - The `Result` from `reconcile_selected` is discarded — if the initial mount after adding a favorite fails, no error is shown to the user
  - Spec 06 line 8: "On add: create symlink, write share to config, attempt immediate mount"
- **Work:**
  - Unwrap the `Result` and report mount failures to the user
  - Do not bail (the favorite was already saved successfully), but print the mount error

---

## P2 — Network Event Integration

### P2.1 Wire SCDynamicStore events into V2 reconcile loop
- **Specs:** 11-background-monitoring
- **Status:** [PARTIAL] — `network/monitor.rs` is complete but unreachable (no `mod network;` in main.rs)
- **Files:** `crates/mountaineer/src/main.rs` (cmd_monitor), `crates/mountaineer/src/tray.rs`, `crates/mountaineer/src/network/monitor.rs`
- **Evidence:**
  - `network/monitor.rs` fully implements SCDynamicStore watcher: `start()` spawns a background thread, returns `mpsc::Receiver<NetworkChangeEvent>`, watches 5 patterns covering IPv4/IPv6/Link/Global changes
  - Tray reconcile loop (tray.rs:71-94) only uses `cx.background_executor().timer(Duration::from_secs(check_interval))` — never consumes network events
  - `cmd_monitor` (main.rs:130-152) uses `thread::sleep` — never consumes network events
- **Depends on:** P0.1 (must add `mod network;` first)
- **Work:**
  - In `cmd_monitor`: start `network::monitor::start()`, select on timer OR network event channel
  - In tray reconcile loop: same — wake on network event or timer
  - Trigger immediate reconcile cycle on network change event

### P2.2 Add 500ms debounce for network events
- **Specs:** 11-background-monitoring
- **Status:** [MISSING] — debounce existed in dead `watcher.rs` only (watcher.rs:28-29)
- **Files:** `crates/mountaineer/src/main.rs`, `crates/mountaineer/src/tray.rs` (wherever network events are consumed)
- **Work:**
  - After receiving a network change event, drain channel for 500ms before triggering reconcile
  - Prevents thrashing on rapid interface changes (e.g., wake from sleep)

---

## P3 — Dead Code Cleanup

### P3.1 Remove or gate `wol.rs`
- **Specs:** 01-design-principles (WoL not in any spec as a current feature)
- **Status:** Complete code, zero callers. No MAC address field in `ShareConfig`, no CLI command. No `mod wol;` in main.rs.
- **Files:** `crates/mountaineer/src/wol.rs`
- **Evidence:**
  - `send_wol(mac_address)` is the only public function — grep for `send_wol` across entire crate returns only the definition itself
  - Has 4 unit tests (`parse_mac_colon_separated`, `parse_mac_hyphen_separated`, `parse_mac_invalid`, `magic_packet_structure`)
  - Implementation is correct: standard 102-byte WoL magic packet via UDP broadcast to `255.255.255.255:9`
- **Work:**
  - **Recommendation:** Keep the file but do not add `mod wol;` to main.rs until a spec is authored
  - No action needed — file is already excluded from compilation

### P3.2 Evaluate `network/interface.rs`
- **Specs:** None currently reference it
- **Status:** Complete, tested, unused. Marked `#[allow(dead_code)]` at module declaration level in `network/mod.rs:1`
- **Files:** `crates/mountaineer/src/network/interface.rs`, `crates/mountaineer/src/network/mod.rs`
- **Evidence:**
  - `enumerate_interfaces()` is the single public function — uses `system_configuration::network_configuration::get_interfaces()` and `nix::ifaddrs::getifaddrs()` to build a list of active network interfaces with type (Ethernet/WiFi) and IP addresses
  - No callers in any compiled code
- **Work:**
  - **Recommendation:** Keep — may be useful for richer status display, auto-detection of Thunderbolt NIC, or future specs
  - Ensure `#[allow(dead_code)]` stays until it gains callers

### P3.3 Clean up unused functions in `discovery.rs`
- **Specs:** 01-design-principles (prune V1)
- **Status:** File-level `#![allow(dead_code)]` suppresses all warnings
- **Files:** `crates/mountaineer/src/discovery.rs`
- **Evidence — used vs. unused functions:**
  - **USED:** `is_smb_reachable_with_timeout` (called from engine.rs:1034) — TCP 445 probe with configurable timeout
  - **UNUSED:** `discover_mounted_shares` (only called from watcher.rs which is not compiled)
  - **UNUSED:** `discover_mac_address` (zero callers anywhere)
  - **UNUSED:** `is_smb_reachable` (wrapper for `_with_timeout`, only called from watcher.rs)
  - **UNUSED:** `check_share_available` (zero callers — candidate for future probe enhancement)
  - **UNUSED:** `is_server_reachable` (zero callers)
  - **UNUSED:** All private helpers for `discover_mounted_shares`: `parse_mount_smbfs`, `parse_smbutil_statshares`, `resolve_hostname`, `get_route_interface`, `parse_hardware_ports`
- **Work:**
  - Remove `#![allow(dead_code)]` — let compiler identify true dead code
  - Remove functions with no callers and no realistic path to integration: `discover_mounted_shares` and all its private helpers, `discover_mac_address`, `is_smb_reachable`, `is_server_reachable`
  - Keep: `is_smb_reachable_with_timeout` (actively used), `check_share_available` (candidate for probe enhancement)

### P3.4 Deduplicate `set_symlink_atomically`
- **Files:** `crates/mountaineer/src/engine.rs` (line 1266)
- **Evidence:** The tray.rs duplicate has been removed. Only the engine.rs version remains. However, it is still private (`fn`), not `pub(crate)`.
- **Status:** [PARTIAL] — Duplicate removed from tray.rs. Engine version remains private; make `pub(crate)` if other modules need it.

### P3.5 Consolidate `share_statuses` and `verify_all`
- **Files:** `crates/mountaineer/src/engine.rs` (lines 607-609, 115)
- **Evidence:** `share_statuses` (engine.rs:607-609) is literally `verify_all(config, state)` — a 1-line wrapper returning the same result.
- **Status:** [DONE] — Removed `share_statuses` wrapper function from engine.rs. Updated sole caller in `cmd_status` (main.rs) to call `verify_all` directly.
- **Work:**
  - Remove `share_statuses` and update all callers to use `verify_all` directly
  - Callers: `cmd_status` in main.rs:161

### P3.6 Move alias symlink removal into engine
- **Specs:** 01-design-principles ("All UI actions call the same engine functions as CLI")
- **Status:** [PARTIAL] — `cmd_alias remove` directly calls `fs::remove_file` for symlink
- **Files:** `crates/mountaineer/src/main.rs` (line ~329), `crates/mountaineer/src/engine.rs`
- **Evidence:**
  - `cmd_alias remove` in main.rs: after `engine::remove_alias()`, directly calls `std::fs::remove_file` on the alias symlink path
  - This bypasses the engine for a filesystem operation that should be part of the removal lifecycle
  - `remove_alias` only removes the alias from the config `Vec`; the symlink deletion is left to the caller
- **Work:**
  - Move symlink removal into `engine::remove_alias` (or a new `engine::remove_alias_with_cleanup`)
  - Ensure the same cleanup happens whether triggered from CLI or tray UI

---

## P4 — Tray UI Enhancements (Current GPUI framework)

> **Architectural note:** Spec 01 mandates Swift/native for menu bar (not GPUI). These items
> are listed for completeness but implementation should be deferred until the GPUI -> Swift
> migration decision (P6) is resolved. If GPUI is kept short-term, these can proceed.
> Current tray is built on the `tray_icon` crate with GPUI providing the application runtime and async executor.

### P4.1 "Open Logs" quick action
- **Specs:** 19-tray-quick-actions
- **Status:** [MISSING]
- **Evidence:** "Open Shares Folder" exists (tray.rs:382-390, id `"open-shares"`) but no "Open Logs"
- **Work:** Add menu item (id `"open-logs"`) that runs `open ~/Library/Logs/mountaineer.log` (path from `logging::log_path()`)
- **Prerequisite:** `logging::log_path()` is currently private (`logging.rs:57`); must be changed to `pub(crate)` or `pub`

### P4.2 `auto_failback` toggle in tray
- **Specs:** 19-tray-quick-actions
- **Status:** [MISSING]
- **Evidence:** No toggle items exist in tray menu — only action items and info labels
- **Work:** Checkmark menu item; on click: load config -> toggle `auto_failback` -> atomic save -> rebuild menu

### P4.3 `lsof_recheck` toggle in tray
- **Specs:** 19-tray-quick-actions
- **Status:** [MISSING]
- **Depends on:** P1.2 (field must exist in config)

### P4.4 Visual toggle state indicators
- **Specs:** 19-tray-quick-actions
- **Status:** [MISSING]
- **Work:** Show checkmark or on/off label next to toggle items (currently no `CheckMenuItem` used anywhere)

### P4.5 `last_error` display per share
- **Specs:** 18-tray-status-display
- **Status:** [MISSING]
- **Evidence:** `BackendStatus.last_error` and `ShareStatus.last_error` exist; `print_status_table` in main.rs:517-520 shows `last_error` in CLI output; tray `build_dynamic_menu` does not display it
- **Work:** Show `last_error` string in share submenu when non-empty

### P4.6 Dynamic tray icon reflecting overall health
- **Specs:** 18-tray-status-display
- **Status:** [PARTIAL] — currently static white triangle
- **Evidence:** `make_icon()` (tray.rs:430-451) generates a fixed 16x16 white triangle bitmap; `tray_icon.set_icon()` is never called after initialization
- **Work:** Icon variants: all-healthy (normal), some-degraded (warning), all-disconnected (error). Call `tray.set_icon(...)` after each reconcile cycle based on aggregate status.

### P4.7 Force-switch option on open-files warning
- **Specs:** 14-tray-tb-recovery
- **Status:** [MISSING] — `BusyOpenFiles` case only logs a warning
- **Evidence:** `handle_switch` at tray.rs:233-238 handles `SwitchResult::BusyOpenFiles` with `log::warn!` only — no UI feedback, no force-switch option, `force` parameter hardcoded `false` at tray.rs:210
- **Work:** Show "Force Switch to TB" menu item with file count when `BusyOpenFiles` returned. Must also show warning text about open files.

### P4.8 In-progress indicators during switch/mount operations
- **Specs:** 14-tray-tb-recovery, 17-tray-bulk-operations
- **Status:** [MISSING]
- **Evidence:** `handle_switch` executes synchronously — menu is only rebuilt after completion (tray.rs:224-230). No intermediate "switching..." state.
- **Work:** Show temporary "Switching..." or "Mounting..." state in menu during async operations

---

## P5 — Tray UI Phase 2 Features

### P5.1 Favorites management from tray
- **Specs:** 15-tray-favorites
- **Status:** [MISSING]
- **Evidence:** Engine functions exist (`add_or_update_share`, `remove_share`, `cleanup_removed_share`) and are used by CLI. No tray UI wiring.
- **Work:** "Add Favorite" form (companion window or panel — tray menus have limited input capability), "Remove Favorite" per-share action with confirmation dialog and alias impact reporting. Calls same engine functions as CLI.

### P5.2 Alias management from tray
- **Specs:** 16-tray-aliases
- **Status:** [MISSING]
- **Evidence:** Engine functions exist (`add_alias`, `remove_alias`, `inspect_aliases`, `list_folders`) and are used by CLI. No tray UI wiring.
- **Work:** Folder browser (companion window — share must be mounted), alias creation/removal. Calls same engine functions.

### P5.3 Bulk operations from tray
- **Specs:** 17-tray-bulk-operations
- **Status:** [MISSING]
- **Evidence:** Engine functions exist (`reconcile_all`, `unmount_all`) and are used by CLI. No tray UI wiring.
- **Work:** "Mount All" and "Unmount All" menu items. No force-unmount in tray (CLI only per spec). Show per-share results after operation.

---

## P6 — GPUI -> Swift/Native Migration

### P6.1 Replace GPUI with native macOS menu bar implementation
- **Specs:** 01-design-principles (explicit: "Menu bar UI uses native Swift or a lightweight macOS-native framework -- explicitly NOT GPUI")
- **Status:** [PARTIAL] — GPUI is used for the entire tray/menu bar system
- **Files:** `crates/mountaineer/src/gui.rs`, `crates/mountaineer/src/tray.rs`, `crates/mountaineer/Cargo.toml` (GPUI deps)
- **Evidence:**
  - `gui.rs` creates `gpui::Application`, sets `NSApplication.setActivationPolicy(1)` (Accessory) via unsafe ObjC, delegates to `tray::install`
  - `tray.rs` uses `gpui::AsyncApp`, `cx.spawn(...)`, `cx.background_executor().timer(...)`, `cx.quit()` for the async runtime
  - Actual menu is built with `tray_icon` crate (native NSStatusItem) — not GPUI views
  - GPUI provides the application lifecycle and async executor only — no GPUI views/elements/windows are rendered
- **Work:**
  - **Option A:** Swift companion app with XPC or CLI bridge to Rust engine
  - **Option B:** Rust `objc2`/`cocoa` crate for direct AppKit `NSStatusItem` + `NSApplication.run()` — replace GPUI as the app lifecycle/async runtime
  - **Option C:** Keep GPUI short-term, migrate later when tray features stabilize
  - **Recommendation:** Resolve this architectural decision before implementing P4/P5 tray features to avoid throwaway work. Note: GPUI is only used as a runtime host, not for rendering — migration scope is smaller than it appears.
- **Impact:** Affects all P4 and P5 items. If migrating, those should be built in the new framework.

---

## P7 — Test Coverage

### P7.1 Unit tests for config load/save round-trip
- **Files:** `crates/mountaineer/src/config.rs`
- **Existing tests:** `backend_paths_use_suffixes` (line 241 — tests dual-mount helper, to be removed with P0.2), `alias_target_joins_subpath` (line 249 — valid)
- **Work:** Test TOML serialization/deserialization, path expansion, validation, atomic save

### P7.2 Unit tests for CLI dispatch
- **Files:** `crates/mountaineer/src/main.rs`, `crates/mountaineer/src/cli.rs`
- **Existing tests:** None
- **Work:** Test clap argument parsing for all commands including new `--force` flags and `config set`

### P7.3 Integration tests for engine reconciliation
- **Files:** `crates/mountaineer/src/engine.rs`
- **Existing tests:** None (engine has no `#[cfg(test)]` module)
- **Work:** Mock mount/unmount/probe functions; test failover and recovery state machines, TB stability window, lsof_recheck gating

### P7.4 Tests for launchd install/uninstall
- **Files:** `crates/mountaineer/src/launchd.rs`
- **Existing tests:** None
- **Work:** Test plist generation content, KeepAlive dict structure, idempotent uninstall

### P7.5 Remove or fix system-dependent tests
- **Files:** `crates/mountaineer/src/discovery.rs`, `crates/mountaineer/src/network/interface.rs`
- **Evidence:** `network/interface.rs` likely has tests like `enumerate_returns_at_least_one_interface` that depend on dev machine network state
- **Work:** Either mock system calls or mark with `#[ignore]`

---

## Confirmed Working (No Action Needed)

These aspects of the code are confirmed correct against their specs:

- **Failover guard logic** (Spec 03 line 13): `reconcile_share` at engine.rs:722 checks `other_reachable` before calling `switch_backend_single_mount` — TB is NOT unmounted if FB is unreachable. Correct.
- **Dual-mode logging** (Spec 13): `logging.rs` correctly implements `LoggingMode::Gui` (file-only) and `LoggingMode::Cli` (stderr + file) with `LineWriter` for immediate flush. Log path `~/Library/Logs/mountaineer.log` consistent between `logging::log_path()` and `launchd::generate_plist()`.
- **Alias lifecycle** (Spec 07): `add_alias` validates share exists (engine.rs:492-494) and rejects duplicate alias names case-insensitively (engine.rs:484-490). `reconcile_aliases` called from `reconcile_all` (engine.rs:131). Atomic symlink creation via `set_symlink_atomically`.
- **auto_failback defaults to false** (Spec 02): `default_auto_failback()` returns `false` at config.rs:106. Correct.
- **TB stability window** (Spec 04): `auto_failback_stable_secs` (default 30) is checked at engine.rs:772-773 before auto-failback. Window resets when TB drops (engine.rs:663 clears `tb_reachable_since`). Correct.
- **Rollback on mount failure** (Spec 04): `switch_backend_single_mount` at engine.rs:321-341 attempts remount of old backend on failure and restores symlink if rollback succeeds.
- **TB recovery pending clears on TB drop** (Spec 04): engine.rs:664 sets `tb_recovery_pending = false` when TB becomes unreachable. Correct.
- **shares_root config field** (Spec 02/05): `shares_root_path(config)` reads from `config.global.shares_root` (default `~/Shares`), not hardcoded. Correct.
- **Tray config hot-reload** (Spec 11): tray.rs:74 calls `config::load()` on every reconcile cycle. Correct.

---

## Environment & Toolchain Notes

These are non-obvious environment facts discovered during implementation. They are not work items but must be known to avoid repeating troubleshooting.

- **gpui API change:** `Application::new()` no longer exists in current gpui. Must use `gpui_platform::application()` which calls `Application::with_platform(current_platform(false))`. `gpui_platform` has been added as a workspace dependency with the `runtime_shaders` feature.
- **Xcode license blocker:** Building requires either Xcode license accepted or `DEVELOPER_DIR=/Library/Developer/CommandLineTools` env var set. Metal shader compilation needs the `runtime_shaders` feature on `gpui_platform` to avoid requiring the Metal toolchain at build time.
- **Root main.rs:** A stale GPUI hello-world `main.rs` existed at the repo root (not in `src/`). Deleted as part of workspace manifest cleanup (P0.0).

---

## Summary — Implementation Order

```
Phase 1: Foundation (P0.0 -> P0.8)
  [DONE] Fix workspace manifest -> [DONE] Wire mod network -> [DONE] Remove dual-mount ->
  [DONE] Fix volume paths + detect_active_backend -> [DONE] Fix config path ->
  [DONE] Fix unmount symlink preservation -> [DONE] Fix cmd_switch -> [DONE] Fix tray engine bypass ->
  [DONE] Remove watcher.rs

Phase 2: Spec Compliance (P1.1 -> P1.15)
  --force flags -> lsof_recheck -> config set -> reject duplicates ->
  tb_recovery_pending in status -> atomic persistence -> idempotent uninstall ->
  KeepAlive fix -> config validation -> config hot-reload ->
  failover retry -> stale mount pre-cleanup ->
  fix cmd_mount auto-switch -> fix favorites add error handling

Phase 3: Network Events (P2.1 -> P2.2)
  Wire SCDynamicStore -> Add debounce

Phase 4: Dead Code (P3.1 -> P3.6)
  Gate wol.rs -> Evaluate interface.rs -> Clean discovery.rs ->
  Dedup symlink fn -> Consolidate share_statuses/verify_all ->
  Move alias symlink removal into engine

Phase 5: Architectural Decision (P6.1)
  Decide GPUI vs Swift/native -- blocks P4/P5

Phase 6: Tray Enhancements (P4.1 -> P4.8)
  Quick actions -> Toggles -> Error display -> Dynamic icon -> Force-switch -> Progress

Phase 7: Tray Phase 2 (P5.1 -> P5.3)
  Favorites UI -> Alias UI -> Bulk ops UI

Phase 8: Test Coverage (P7.1 -> P7.5)
  Config tests -> CLI tests -> Engine tests -> Launchd tests -> Fix flaky tests
```

---

## Change Log

### 2026-02-27 (v7 — P1 spec compliance batch)
- **P1.1 [DONE]:** Added `--force` flag to `Switch` and `Unmount` CLI commands. `unmount_all` now accepts `force: bool` — skips open-file check and uses hard unmount when true.
- **P1.2 [DONE]:** Added `lsof_recheck: bool` (default `true`) to `GlobalConfig`. Gates periodic lsof re-check during auto-failback in reconcile cycle per spec 04.
- **P1.5 [DONE]:** Added `tb_recovery_pending: bool` to `ShareStatus`. CLI status table now shows "TB READY" column. Included in JSON output.
- **P1.6 [DONE]:** `save_runtime_state` uses atomic temp-then-rename pattern (`.json.tmp` → `.json`).
- **P1.7 [DONE]:** `Config::save()` uses atomic temp-then-rename pattern (`.toml.tmp` → `.toml`).
- **P1.8 [DONE]:** `launchd::uninstall()` returns Ok with info log when plist absent (idempotent).
- **P1.9 [DONE]:** `KeepAlive` in plist now uses `SuccessfulExit = false` dict for crash-restart behavior.
- **P1.11 [DONE]:** `cmd_monitor` hot-reloads config each cycle inside the poll loop.
- **P3.5 [DONE]:** Removed `share_statuses` wrapper; caller uses `verify_all` directly.
- **25 tests pass.** No clippy warnings.

### 2026-02-27 (v6 — P0 complete)
- **P0.2 [DONE]:** Removed all dual-mount code. Deleted `single_mount_mode`, `mount_root`, `backend_mount_path`, `sanitize_share_name`, `mount_suffix`, `MountBackends` CLI command, `switch_share()` (dual-mount switch), `choose_desired_backend()` (dual-mount), `mount_backends_for_shares()`. Removed dual-mount branch from `reconcile_share`. Simplified `unmount_all`/`unmount_all_for_share`. Engine dropped ~200 lines.
- **P0.3 [DONE]:** All mount paths now use `/Volumes/<SHARE>` via `config::volume_mount_path()`. `detect_active_backend` relies solely on `RuntimeState.active_backend`. Stable symlinks point to `/Volumes/<SHARE>`.
- **P0.6 [DONE]:** `cmd_switch` now calls `switch_backend_single_mount` with `from` determined from RuntimeState. Handles all `SwitchResult` variants.
- **P0.7 [DONE]:** Tray `handle_switch` no longer bypasses engine for initial mounts — uses `engine::reconcile_all()`. Removed duplicate `set_symlink_atomically` from tray.rs.
- **P3.4 updated:** Duplicate `set_symlink_atomically` removed from tray.rs. Only engine.rs copy remains.
- **25 tests pass** (was 22 before P0.1, now 25 including 3 new `choose_desired_backend` tests).
- **All P0 items now complete.** Phase 1 (Architectural Foundation) is finished.

### 2026-02-27 (v5 — P0 partial completion)
- **P0.0 [DONE]:** Workspace manifest fixed. Root `Cargo.toml` converted to workspace; all 13 deps defined in `[workspace.dependencies]`; `gpui_platform` added with `runtime_shaders` feature; stale root `main.rs` removed; `Cargo.lock` updated.
- **P0.1 [DONE]:** `mod network;` added to `main.rs`. Network module (monitor.rs, interface.rs) now compiles. All 22 tests pass including 5 network tests.
- **P0.4 [DONE]:** Config path changed from `dirs::config_dir()` (`~/Library/Application Support/`) to `dirs::home_dir().join(".mountaineer/")`. Both `config_path()` and `state_path()` updated.
- **P0.5 [DONE]:** Symlink removal block removed from `unmount_all`. Stable symlinks now persist across unmount per spec 05/08.
- **P0.8 [DONE]:** `watcher.rs` deleted.
- **Added "Environment & Toolchain Notes" section:** Documents gpui API change (`Application::new()` -> `gpui_platform::application()`), Xcode license build blocker, and stale root `main.rs` discovery — to prevent future agents repeating the same troubleshooting.

### 2026-02-27 (v4 — full re-verification)
- **Re-verified all items** by studying all 19 specs and all 16 source files with 12 parallel subagents
- **All existing items confirmed accurate** — no corrections needed to v3 findings
- **All 9 "Confirmed Working" items re-verified** — all remain correct
- **Added P1.14:** `cmd_mount` delegates to `reconcile_all` with `auto_switch=true`, which can trigger failover/recovery on already-mounted shares. Spec 08 requires "skip shares that are already mounted." Need dedicated mount-only path.
- **Added P1.15:** `favorites add` silently discards the `Result` from `engine::reconcile_selected` at main.rs:374 (`let _`). Mount errors after adding a favorite are invisible to the user.
- **Added P3.6:** `cmd_alias remove` in main.rs directly calls `std::fs::remove_file` on the alias symlink instead of delegating to the engine. Violates the engine-as-single-path principle.
- **Added note to P4.1:** `logging::log_path()` is private; needs visibility change before "Open Logs" tray action can use it.
- **Updated Summary:** Phase 2 now extends to P1.15, Phase 4 now extends to P3.6.

### 2026-02-27 (v3 — comprehensive audit)
- **Deep verification pass** using parallel subagents across all 19 specs and all 16 source files
- **Added "Confirmed Working" section** — 9 aspects verified correct against specs, documented to prevent future false-positive issues
- **P0.0 updated:** Confirmed no root `src/main.rs` exists (removed stale reference). Added detail about `chrono` and `objc` being explicit-version deps. Added Cargo.lock evidence that workspace config previously existed.
- **P0.2 expanded:** Added `sanitize_share_name()`, `unmount_all_for_share()` as items to update. Added exact line numbers for all dual-mount artifacts.
- **P0.3 expanded:** Added critical finding — `detect_active_backend` (engine.rs:1208-1225) compares symlink target to `backend_mount_path` values; after fix, symlink always points to `/Volumes/<SHARE>` so this function needs rewrite to rely on `RuntimeState.active_backend`. Added note about mount point directory management (`/Volumes/` owned by macOS).
- **P1.2 expanded:** Added exact location of missing `lsof_recheck` gate (reconcile_share TB-recovery branch at engine.rs:758-820).
- **P1.13 clarified:** `probe_backend` DOES have stale mount cleanup (engine.rs:1039-1071) during reconciliation probes — but `switch_backend_single_mount` does NOT. Reclassified from [MISSING] to [PARTIAL].
- **P3.3 expanded:** Full audit of every function in `discovery.rs` with used/unused classification.
- **P4 note updated:** Clarified that GPUI provides only the app lifecycle/async runtime — actual menu uses `tray_icon` crate. Migration scope is smaller than initially assessed.
- **All items** received evidence sections with exact file paths and line numbers from source code verification.

### 2026-02-27 (v2)
- **Added P0.0:** Workspace manifest is broken -- no `[workspace]` section but `crates/mountaineer/Cargo.toml` uses `.workspace = true` for 13 deps. Build is completely blocked. Promoted to P0.0 (highest priority).
- **Added P0.1:** `mod network;` not declared in `main.rs` -- entire network module unreachable. Prerequisite for P2.1.
- **Added P0.7:** Tray bypasses engine for mount-from-none (tray.rs lines 169-200 calls `mount::smb::mount_share` directly). Violates spec 01 principle.
- **Added P1.12:** Failover retry policy not implemented -- spec 03 requires retry of Fallback once on failure.
- **Added P1.13:** Stale mount detection/cleanup before remount -- spec 03 requires it, `is_mount_alive` exists but not used as pre-cleanup.
- **Added P3.5:** `share_statuses` is a 1-line wrapper for `verify_all` -- consolidate.
- **Renumbered:** Old P0.7 (workspace cleanup) absorbed into new P0.0. Old P0.6 (watcher.rs) renumbered to P0.8. Items reordered to reflect dependency chain.
- **All file paths** updated from relative names to `crates/mountaineer/src/` paths for clarity.
- **Evidence sections** added to items where source-level verification was performed.
